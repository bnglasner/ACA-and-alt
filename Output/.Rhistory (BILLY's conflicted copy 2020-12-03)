}
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
setwd(paste0(path_data))
options(scipen=10000)
set.seed(42)
industry_analysis <- 1
load("medicaid_analysis_data_total.RData")
# load("medicaid_analysis_data_allnonemployers.RData")
# using <- subset(using, naics=="48-49")
using$market_type[using$concentration_lower==1] <- "Oligopsony"
using$market_type[using$concentration_lower==2] <- "Moderate"
using$market_type[using$concentration_lower==3] <- "Competitive"
using$Uber_active_num <- using$Uber_active
using$Uber_active[using$Uber_active==0] <- "No Uber"
using$Uber_active[using$Uber_active==1] <- "Uber Active"
using$market_type <- factor(using$market_type, levels = c("Oligopsony","Moderate","Competitive"))
using$Medicaid_Uber <- using$Medicaid*using$Uber_active_num
using$Work_require <- 0
using$Work_require[using$st==5 & using$years==2018] <- 1
using <- within(using, quantile <- as.integer(cut(HHI_lower, quantile(HHI_lower, probs=seq(0,1,.01), na.rm = TRUE), include.lowest=TRUE)))
using$quantile <- as.numeric(as.character(using$quantile))
#################################################################
#                         Synth-DID set up                      #
#################################################################
###
Medicaid_subset <- subset(using, Medicaid==1)
Medicaid_subset <- Medicaid_subset[order(Medicaid_subset$id, abs(Medicaid_subset$years) ), ]
Medicaid_subset <- Medicaid_subset[ !duplicated(Medicaid_subset$id), ]
Medicaid_subset$first.treat <- Medicaid_subset$years
Medicaid_subset <- Medicaid_subset %>% select("id","first.treat")
using <- merge(using, Medicaid_subset, all = TRUE)
using$first.treat[is.na(using$first.treat)] <- 0
using$id_numeric <- as.numeric(using$id)
###
Medicaid_subset <- subset(using, Uber_active_num==1)
Medicaid_subset <- Medicaid_subset[order(Medicaid_subset$id, abs(Medicaid_subset$years) ), ]
Medicaid_subset <- Medicaid_subset[ !duplicated(Medicaid_subset$id), ]
Medicaid_subset$first.treat.uber <- Medicaid_subset$years
Medicaid_subset <- Medicaid_subset %>% select("id","first.treat.uber")
using <- merge(using, Medicaid_subset, all = TRUE)
using$first.treat.uber[is.na(using$first.treat.uber)] <- 0
###
Medicaid_subset <- subset(using, Medicaid==1 & Uber_active_num==1)
Medicaid_subset <- Medicaid_subset[order(Medicaid_subset$id, abs(Medicaid_subset$years) ), ]
Medicaid_subset <- Medicaid_subset[ !duplicated(Medicaid_subset$id), ]
Medicaid_subset$first.treat.uber.medicaid <- Medicaid_subset$years
Medicaid_subset <- Medicaid_subset %>% select("id","first.treat.uber.medicaid")
using <- merge(using, Medicaid_subset, all = TRUE)
using$first.treat.uber.medicaid[is.na(using$first.treat.uber.medicaid)] <- 0
###
Med_diff_estabpop <-  att_gt(yname="estab_pop",
first.treat.name="first.treat",
idname="id_numeric",
tname="years",
xformla=~receipt_estab+Labor.Force+quantile+Unemployment.Rate,
data=using,
weightsname = "lf_avg",
control.group = "notyettreated",
# clustervars = "st",
bstrap = TRUE,
panel = TRUE,
estMethod = "reg",
printdetails=FALSE)
es_estabpop <- aggte(Med_diff_estabpop, type="dynamic")
es_estabpop_df <- data.frame(es_estabpop[["egt"]],es_estabpop[["att.egt"]],es_estabpop[["se.egt"]])
names(es_estabpop_df) <- c("Period", "ATT", "se")
es_estabpop_df$Var <- "Estab./Labor Force"
summary(es_estabpop)
###
Med_diff_rcp <-  att_gt(yname="receipt_estab",
first.treat.name="first.treat",
idname="id_numeric",
tname="years",
xformla=~estab+estab_pop+Labor.Force+quantile+Unemployment.Rate,
data=using,
weightsname = "lf_avg",
control.group = "notyettreated",
# clustervars = "st",
# bstrap = TRUE,
panel = TRUE,
# estMethod = "dr",
estMethod = "reg",
printdetails=FALSE)
es_rcp <- aggte(Med_diff_rcp, type="dynamic")
es_rcp_df <- data.frame(es_rcp[["egt"]],es_rcp[["att.egt"]],es_rcp[["se.egt"]])
names(es_rcp_df) <- c("Period", "ATT", "se")
es_rcp_df$Var <- "Avg. Rec."
summary(es_rcp)
es_df <- rbind(es_estabpop_df,es_rcp_df)
es_df$Treatment <- "Pre-Expansion"
es_df$Treatment[es_df$Period>-1] <- "Post-Expansion"
myColors <- c("green3","black")
names(myColors) <- levels(es_df$Treatment)
colScale <- scale_colour_manual(name = "grp",values = myColors)
p1 <-ggplot(data = es_df,
aes(x = Period,
color = Treatment)) +
geom_point(aes(y = ATT), size =3) +
geom_errorbar(aes(ymin=ATT-1.96*se, ymax=ATT+1.96*se), size = 1)+
geom_hline(yintercept = 0, color = "black") +
labs(x = "HHI Quantile") +
theme(axis.text = element_text(size = 30),
axis.title.y = element_blank(),
axis.title.x = element_text(size = 20),
axis.text.y.right = element_text(margin = margin(r=15)),
strip.text.x = element_text(size = 20),
strip.text.y = element_text(size = 20),
strip.background = element_rect(fill = "white"),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
panel.spacing = unit(2, "lines"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.background = element_rect(fill=alpha("white", 0.4)),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 25),
legend.title = element_blank()) +
colScale +
scale_y_continuous(label=comma) +
facet_grid( Var ~ .,
scales = "free_y")
setwd(path_output)
pdf(file = paste0("Event_study_allnonemployer.pdf"), width = 12, height = 10)
plot(p1)
dev.off()
p1
# Ben Glasner
# Medicaid and nonemployers analysis
# Industry analysis of nonemployers
# Perform panel analysis in R to get the stargazer output for latex
##################
###  Library   ###
##################
library(stargazer)
library(lfe)
library(estimatr)
library(ggplot2)
library(ggeffects)
library(broom)
library(scales)
library(gsynth)
library(dplyr)
library(see)
gsynth_1 <- gsynth(Y = "estab_pop",
D = "Medicaid",
X = c("Uber_active_num",
"receipt_estab",
"rcptot",
"estab",
"Labor.Force",
"HHI_lower",
"population",
"Unemployment.Rate"),
data = using,
index = c("cty_st_numeric","years"),
weight = "lf_avg",
force = "two-way",
r = c(0, 5),
min.T0 = 8,
CV = TRUE,
se = TRUE,
EM = TRUE,
# estimator = "mc",
# nlambda = 10,
# inference = "parametric",
inference = "nonparametric",
nboots = 500,
parallel = TRUE,
cl =  "st",
cores = 3)
library(devtools)
install_github("xuyiqing/gsynth")
install.packages("Rtools")
install.packages("rtools40")
install.packages(c("backports", "bayestestR", "bibtex", "bit", "bit64", "broom", "callr", "choroplethr", "chron", "cli", "clipr", "clubSandwich", "colorspace", "conquer", "covr", "data.table", "dbplyr", "devtools", "digest", "dplyr", "DT", "dtw", "e1071", "effectsize", "emmeans", "estimatr", "fields", "foghorn", "Formula", "fredr", "fs", "generics", "gganimate", "ggeffects", "glue", "Hmisc", "htmlTable", "htmlwidgets", "httr", "igraph", "insight", "ipumsr", "iterators", "jomo", "jsonlite", "knitr", "labeling", "lme4", "lmtest", "lubridate", "magick", "magrittr", "maptools", "MatchIt", "matrixStats", "maxLik", "mice", "miceadds", "naniar", "openssl", "parameters", "performance", "pillar", "pkgdown", "plm", "proxy", "ps", "quantreg", "R.methodsS3", "R.oo", "R.utils", "R6", "raster", "Rdpack", "readr", "remotes", "rgdal", "rJava", "rlang", "rmarkdown", "rprojroot", "RSQLite", "rstudioapi", "rvest", "sandwich", "see", "sf", "sjlabelled", "sjPlot", "sp", "spelling", "statar", "statmod", "stringdist", "stringi", "sys", "tibble", "tidyr", "tinytex", "usethis", "usmap", "vctrs", "withr", "xfun", "xlsx", "xmlparsedata", "xts"))
install.packages(c("backports", "bayestestR", "bibtex", "bit", "bit64", "broom", "callr", "choroplethr", "chron", "cli", "clipr", "clubSandwich", "colorspace", "conquer", "covr", "data.table", "dbplyr", "devtools", "digest", "dplyr", "DT", "dtw", "e1071", "effectsize", "emmeans", "estimatr", "fields", "foghorn", "Formula", "fredr", "fs", "generics", "gganimate", "ggeffects", "glue", "Hmisc", "htmlTable", "htmlwidgets", "httr", "igraph", "insight", "ipumsr", "iterators", "jomo", "jsonlite", "knitr", "labeling", "lme4", "lmtest", "lubridate", "magick", "magrittr", "maptools", "MatchIt", "matrixStats", "maxLik", "mice", "miceadds", "naniar", "openssl", "parameters", "performance", "pillar", "pkgdown", "plm", "proxy", "ps", "quantreg", "R.methodsS3", "R.oo", "R.utils", "R6", "raster", "Rdpack", "readr", "remotes", "rgdal", "rJava", "rlang", "rmarkdown", "rprojroot", "RSQLite", "rstudioapi", "rvest", "sandwich", "see", "sf", "sjlabelled", "sjPlot", "sp", "spelling", "statar", "statmod", "stringdist", "stringi", "sys", "tibble", "tidyr", "tinytex", "usethis", "usmap", "vctrs", "withr", "xfun", "xlsx", "xmlparsedata", "xts"))
# Ben Glasner
# Medicaid and nonemployers analysis
# Industry analysis of nonemployers
# Perform panel analysis in R to get the stargazer output for latex
##################
###  Library   ###
##################
library(stargazer)
library(lfe)
library(sjPlot)
library(estimatr)
library(ggplot2)
library(broom)
library(scales)
library(devtools)
install_github("xuyiqing/gsynth")
install.packages("usethis")
library(devtools)
install.packages("usethis")
install.packages("devtools", dependencies = TRUE, INSTALL_opts = '--no-lock')
library(devtools)
install.packages("devtools", dependencies = TRUE, INSTALL_opts = '--no-lock')
library(devtools)
install_github("xuyiqing/gsynth")
install_github("xuyiqing/gsynth")
# install_github("xuyiqing/gsynth")
library(gsynth)
library(did)
if(Sys.info()[["user"]]=="bglasner"){
# Root folder
path_project <- "C:/Users/bglasner/Dropbox/PhD Requirements"
}
if(Sys.info()[["user"]]=="bngla"){
# Root folder
path_project <- "C:/Users/bngla/Dropbox/PhD Requirements"
}
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
setwd(paste0(path_data))
options(scipen=10000)
set.seed(42)
industry_analysis <- 1
load("state_NES_ACS_CPS.RData")
load("LAU.RData")
LAU_st <- aggregate(x = LAU$`Labor Force`, by = list(LAU$st, LAU$YEAR.id), FUN = sum, na.rm = TRUE)
colnames(LAU_st)[1] <- "st"
colnames(LAU_st)[2] <- "YEAR.id"
colnames(LAU_st)[3] <- "Labor.Force"
state_aggs <- merge(state_aggs, LAU_st)
state_aggs$estab_pop <- state_aggs$estab/state_aggs$Labor.Force
estab_list <- list()
#################################################################
#                         Estab All                             #
#################################################################
estab_list[[1]] <- felm(estab_pop ~ Medicaid | st + YEAR.id | 0 | st,
data = state_aggs,
weights = state_aggs$Labor.Force)
estab_list[[2]] <- felm(Estab_pct_ACS ~ Medicaid | st + YEAR.id | 0 | st,
data = state_aggs,
weights = state_aggs$Labor.Force)
estab_list[[3]] <- felm(Estab_pct_CPS ~ Medicaid | st + YEAR.id | 0 | st,
data = state_aggs,
weights = state_aggs$Labor.Force)
#################################################################
#                         Stargazer                             #
#################################################################
stargazer(estab_list[[1]], estab_list[[2]], estab_list[[3]],
keep = "Medicaid",
keep.stat = c("n","rsq","adj.rsq"),
font.size = "small",
no.space = TRUE,
digits = 4)
#################################################################
#                         Synthetic Control                     #
#################################################################
gsynth_1 <- gsynth(Y = "estab_pop",
D = "Medicaid",
X = c("estab",
"population",
"Labor.Force"),
data = state_aggs,
index = c("st","YEAR.id"),
weight = "Labor.Force",
force = "two-way",
r = c(0, 5),
min.T0 = 8,
CV = TRUE,
se = TRUE,
EM = TRUE,
# estimator = "mc",
# nlambda = 10,
# inference = "parametric",
inference = "nonparametric",
nboots = 1000,
parallel = TRUE,
# cl =  "st",
cores = 20)
gsynth_2 <- gsynth(Y = "Estab_pct_ACS",
D = "Medicaid",
X = c("estab",
"population",
"Labor.Force"),
data = state_aggs,
index = c("st","YEAR.id"),
weight = "Labor.Force",
force = "two-way",
r = c(0, 5),
min.T0 = 8,
CV = TRUE,
se = TRUE,
EM = TRUE,
# estimator = "mc",
# nlambda = 10,
# inference = "parametric",
inference = "nonparametric",
nboots = 1000,
parallel = TRUE,
cl =  "st",
cores = 20)
gsynth_3 <- gsynth(Y = "Estab_pct_CPS",
D = "Medicaid",
X = c("estab",
"population",
"Labor.Force"),
data = state_aggs,
index = c("st","YEAR.id"),
weight = "Labor.Force",
force = "two-way",
r = c(0, 5),
min.T0 = 8,
CV = TRUE,
se = TRUE,
EM = TRUE,
# estimator = "mc",
# nlambda = 10,
# inference = "parametric",
inference = "nonparametric",
nboots = 1000,
parallel = TRUE,
cl =  "st",
cores = 20)
print(gsynth_1)
counter_plot <- cbind(rownames(gsynth_1[["Y.bar"]]), data.frame(gsynth_1[["Y.bar"]], row.names=NULL))
colnames(counter_plot)[1] <- "Year"
counter_plot$Year <- as.numeric(as.character(counter_plot$Year))
plot_1 <- ggplot(data = counter_plot,
aes(x = Year)) +
geom_point(aes(y = Y.tr.bar, colour = "Treated"), size = 3) +
geom_line(aes(y = Y.tr.bar, colour = "Treated"), size = 1.5) +
geom_point(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 3) +
geom_line(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 1.5) +
geom_vline(xintercept = 2014) +
ylab("Establishments/Labor Force, NES") + xlab("Year") +
scale_colour_manual("",
breaks = c("Treated", "Synthetic Control"),
values = c("Treated"="red1", "Synthetic Control"="black")) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))
gap_plot <- cbind(rownames(gsynth_1[["est.att"]]), data.frame(gsynth_1[["est.att"]], row.names=NULL))
colnames(gap_plot)[1] <- "Period"
gap_plot$Period <- as.numeric(as.character(gap_plot$Period))
plot_2 <- ggplot(data = gap_plot,
aes(x = Period,
y = ATT)) +
geom_point(size = 3) +
geom_line(size = 1.5) +
geom_ribbon(aes(ymin=CI.lower, ymax=CI.upper),alpha=0.2) +
geom_hline(yintercept = 0, color = "black") +
geom_vline(xintercept = .5, size = 1.25) +
ylab("Treatment - Control") + xlab("Period") +
# ylim(-0.002,0.009) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
# axis.title.y = element_blank(),
# axis.text.x = element_text(size = 20),
# axis.text.y = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))
###########################################
print(gsynth_2)
counter_plot <- cbind(rownames(gsynth_2[["Y.bar"]]), data.frame(gsynth_2[["Y.bar"]], row.names=NULL))
colnames(counter_plot)[1] <- "Year"
counter_plot$Year <- as.numeric(as.character(counter_plot$Year))
plot_3 <- ggplot(data = counter_plot,
aes(x = Year)) +
geom_point(aes(y = Y.tr.bar, colour = "Treated"), size = 3) +
geom_line(aes(y = Y.tr.bar, colour = "Treated"), size = 1.5) +
geom_point(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 3) +
geom_line(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 1.5) +
geom_vline(xintercept = 2014) +
ylab("Uninc. Self-Emp./Labor Force, ACS") + xlab("Year") +
scale_colour_manual("",
breaks = c("Treated", "Synthetic Control"),
values = c("Treated"="red1", "Synthetic Control"="black")) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))   +
scale_y_continuous(label=comma)
gap_plot <- cbind(rownames(gsynth_2[["est.att"]]), data.frame(gsynth_2[["est.att"]], row.names=NULL))
colnames(gap_plot)[1] <- "Period"
gap_plot$Period <- as.numeric(as.character(gap_plot$Period))
plot_4 <- ggplot(data = gap_plot,
aes(x = Period,
y = ATT)) +
geom_point(size = 3) +
geom_line(size = 1.5) +
geom_ribbon(aes(ymin=CI.lower, ymax=CI.upper),alpha=0.2) +
geom_hline(yintercept = 0, color = "black") +
geom_vline(xintercept = .5, size = 1.25) +
ylab("Treatment - Control") + xlab("Period") +
# ylim(-0.002,0.009) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
# axis.title.y = element_blank(),
# axis.text.x = element_text(size = 20),
# axis.text.y = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))  +
scale_y_continuous(label=comma)
###########################################
print(gsynth_3)
counter_plot <- cbind(rownames(gsynth_3[["Y.bar"]]), data.frame(gsynth_3[["Y.bar"]], row.names=NULL))
colnames(counter_plot)[1] <- "Year"
counter_plot$Year <- as.numeric(as.character(counter_plot$Year))
plot_5 <- ggplot(data = counter_plot,
aes(x = Year)) +
geom_point(aes(y = Y.tr.bar, colour = "Treated"), size = 3) +
geom_line(aes(y = Y.tr.bar, colour = "Treated"), size = 1.5) +
geom_point(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 3) +
geom_line(aes(y = Y.ct.bar, colour = "Synthetic Control"), size = 1.5) +
geom_vline(xintercept = 2014) +
ylab("Uninc. Self-Emp./Labor Force, CPS") + xlab("Year") +
scale_colour_manual("",
breaks = c("Treated", "Synthetic Control"),
values = c("Treated"="red1", "Synthetic Control"="black")) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))   +
scale_y_continuous(label=comma)
gap_plot <- cbind(rownames(gsynth_3[["est.att"]]), data.frame(gsynth_3[["est.att"]], row.names=NULL))
colnames(gap_plot)[1] <- "Period"
gap_plot$Period <- as.numeric(as.character(gap_plot$Period))
plot_6 <- ggplot(data = gap_plot,
aes(x = Period,
y = ATT)) +
geom_point(size = 3) +
geom_line(size = 1.5) +
geom_ribbon(aes(ymin=CI.lower, ymax=CI.upper),alpha=0.2) +
geom_hline(yintercept = 0, color = "black") +
geom_vline(xintercept = .5, size = 1.25) +
ylab("Treatment - Control") + xlab("Period") +
# ylim(-0.002,0.009) +
theme(plot.title = element_text(size=20),
axis.text = element_text(size = 20),
axis.title.y = element_text(size = 20),
axis.title.x = element_text(size = 20),
# axis.title.y = element_blank(),
# axis.text.x = element_text(size = 20),
# axis.text.y = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.title = element_blank(),
legend.key = element_rect(fill="white"),
legend.text = element_text(size = 20),
legend.background = element_rect(fill=NA))  +
scale_y_continuous(label=comma)
setwd(path_output)
pdf(file = paste0("synthetic_total_NES_counterfactual.pdf"), width = 10, height = 8)
plot(plot_1)
dev.off()
pdf(file = paste0("synthetic_total_NES_att.pdf"), width = 10, height = 8)
plot(plot_2)
dev.off()
pdf(file = paste0("synthetic_total_ACS_counterfactual.pdf"), width = 10, height = 8)
plot(plot_3)
dev.off()
pdf(file = paste0("synthetic_total_ACS_att.pdf"), width = 10, height = 8)
plot(plot_4)
dev.off()
pdf(file = paste0("synthetic_total_CPS_counterfactual.pdf"), width = 10, height = 8)
plot(plot_5)
dev.off()
pdf(file = paste0("synthetic_total_CPS_att.pdf"), width = 10, height = 8)
plot(plot_6)
dev.off()
