#################
if(Sys.info()[["user"]]=="bglasner"){
# Root folder
path_project <- "C:/Users/bglasner/Dropbox/PhD Requirements"
}
if(Sys.info()[["user"]]=="bngla"){
# Root folder
path_project <- "C:/Users/bngla/Dropbox/PhD Requirements"
}
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
if(Sys.info()[["nodename"]]=="SIM1"){
# Root folder
path_project <- "H:/Phd Requirements min wage"
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
}
if(Sys.info()[["nodename"]]=="SIM2"){
# Root folder
path_project <- "H:/Phd Requirements min wage"
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
}
if(Sys.info()[["nodename"]]=="SIM3"){
# Root folder
path_project <- "H:/Phd Requirements min wage"
# Path to saved cohort data
path_data <- paste0(path_project,"\\Nonemployer data\\Data\\")
# Path where matched samples should be saved
path_output <- paste0(path_project,"\\ACA and alt\\output")
}
setwd(paste0(path_data))
set.seed(99199)
#################################################################
#                              Set Up                           #
#################################################################
gsynth_list <- list()
EM_list <- list()
MC_list <- list()
inter_fe_list <- list()
lm_list <- list()
load("Nonemployer_statistics_1997_2017.RData") # load the data
medicaid <- read_excel("medicaid.xlsx")
load("county_population_2000_2018.RData")
load("GDP_2001_2018.RData")
load("fips_1997_2018.RData")
load("Uber_2000_2017.RData")
LAU <- read.csv("LAU.csv")
LAU <- LAU %>% dplyr::select("CBSA.Code",
"YEAR.id",
"unemployment_rate",
"unemployment",
"employment",
"labor_force",
"chg_labor_force")
colnames(LAU)[1] <- "CBSA Code"
GDP <- merge(GDP, fips)
using_all <- NES
#################################################################
#                              Industry                         #
#################################################################
industry_list <- sort(unique(using_all$naics))
# i<-1 # for total
# i <- 9 # for 48-49
# i <- 10 # for 4853
# for (i in seq_along(industry_list)) {
setwd(paste0(path_data))
print(paste0(industry_list[1],"start"))
using <- subset(using_all, naics==industry_list[1])
# using <- subset(using_all, naics==industry_list[9]) # transportation and warehousing
#################################################################
#                              Merge                            #
#################################################################
using <- merge(using, medicaid, all.x = TRUE)
using <- merge(using, population, all.x = TRUE)
using <- merge(using, Uber_timing, all.x = TRUE)
using <- merge(using, GDP, all.x = TRUE)
using <- merge(using, LAU, all.x = TRUE)
#################################################################
#                              Clean                            #
#################################################################
# using$estab[is.na(using$estab)] <- 0
using$estab_pop <- (using$estab/using$population) # increase the size of the estab_pop term for easier reading of results
using$id <- as.factor(paste(using$st, using$cty, using$naics, sep = "-")) # create unique id for each county-state
using$cty_st <- as.factor(paste(using$st, using$cty, sep = "-")) # create unique id for each county-state
#######################################################
###     Ever medicaid expansion identification      ###
#######################################################
ever_medicaid <- subset(medicaid, YEAR.id=="2017")
ever_medicaid$Ever_medicaid <- ever_medicaid$Medicaid
ever_medicaid <- ever_medicaid %>% dplyr::select("st", "Ever_medicaid")
using <- merge(using, ever_medicaid)
#######################################################
###     Uber as low barrier indicator ###
#######################################################
# Create column for active Uber at the time of observation
using$uber_year <- year(ymd(using$min_uber)) # pull the year number from the date object "min"
using$Uber_active <-0
using$Uber_active [using$YEAR.id >= using$uber_year] <- 1 # replace the value with 1 if the year of the observation is passed the year UBer entered and it is a location where uber entered
using$uber_yday <- yday(ymd(using$min)) # pull the year number from the date object "min"
using$Uber_year_share <- (366-using$uber_yday)/365
using$Uber_year_share[is.na(using$Uber_year_share)] <- 0
using$Uber_year_share <- as.numeric(using$Uber_year_share)
using$Uber_year_share[using$Uber_active==0] <- 0
using$years_active <- as.numeric(using$YEAR.id - using$uber_year)
using$years_active[is.na(using$years_active)] <- 0
using$years_active[using$years_active < 0] <- 0
using$dosage_uber <- using$years_active + using$Uber_year_share
using$Ever_Uber <- 0
using$Ever_Uber[using$uber_year>2000] <- 1
#######################################################
###     Microsynthetic for local Min Wage increases ###
#######################################################
using$YEAR.id <- as.factor(using$YEAR.id)
using$years <- as.numeric(as.character(using$YEAR.id))
using$st <- as.factor(using$st)
using$cty_st_numeric <- as.numeric(using$cty_st)
using$Medicaid_Uber <- using$Medicaid*using$Uber_active
using$uber_year[is.na(using$uber_year)] <- 0
using$GDP <- as.numeric(as.character(using$GDP))
using$GDP_pop <- using$GDP/using$population
# using_model <- subset(using, estab_pop<.15 & population < 5000000)
# using_model <- using
using_model <- using_model %>% dplyr::select("estab_pop",
"estab",
"population",
"Medicaid",
"Medicaid_Uber",
"Ever_medicaid",
"Uber_active",
"GDP",
"GDP_pop",
"unemployment_rate",
"labor_force",
"uber_year",
"cty_st",
"YEAR.id",
"cty_st_numeric",
"years",
"id",
"st")
using_model_full <- using_model[complete.cases(using_model[c(1,2,3,4,5,6,7,8)]),]
# using_model <- subset(using, estab_pop<.15 & population < 5000000)
using_model <- using
using_model <- using_model %>% dplyr::select("estab_pop",
"estab",
"population",
"Medicaid",
"Medicaid_Uber",
"Ever_medicaid",
"Uber_active",
"GDP",
"GDP_pop",
"unemployment_rate",
"labor_force",
"uber_year",
"cty_st",
"YEAR.id",
"cty_st_numeric",
"years",
"id",
"st")
using_model_full <- using_model[complete.cases(using_model[c(1,2,3,4,5,6,7,8)]),]
using_model_list <- list(using_model_full)
for (K in seq_along(using_model_list)) {
county_counts <- as.data.frame(table(using_model_list[[K]]$id)) # count how many times a county-state appears in the sample
county_counts <- subset(county_counts, Freq==17) # keep only the counties that are in the full sample for balance
# county_counts <- subset(county_counts, Freq==14) # keep only the counties that are in the full sample for balance
colnames(county_counts)[1]<- "id" # relabel the id for the merge
using_model_list[[K]]<- merge(using_model_list[[K]], county_counts) # merge as a way to drop the unbalanced counties
rm(county_counts) # drop county_counts from the env.
}
rm(ever_medicaid,
medicaid,
NES,
population,
Uber_timing,
using_all,
using_model,
using_model_full)
#######################################################
###                   synthetic Control             ###
#######################################################
setwd(paste0(path_output))
for (j in seq_along(using_model_list)) {
# gsynth_list[[j]] <- gsynth(Y = "estab_pop",
#                        D = "Medicaid",
#                        X = c("estab",
#                              "population",
#                              "Uber_active",
#                              "GDP",
#                              "GDP_pop"),
#                        data = using_model_list[[j]],
#                        index = c("cty_st_numeric","years"),
#                        weight = "population",
#                        force = "two-way",
#                        CV = TRUE,
#                        se = TRUE,
#                        r = c(0,10),
#                        inference = "parametric",
#                        nboots = 300,
#                        parallel = TRUE,
#                        cores =20)
EM_list[[j]] <- gsynth(Y = "estab_pop",
D = "Medicaid",
X = c("estab",
"population",
"GDP",
"GDP_pop",
"Uber_active"),
data = using_model_list[[j]],
index = c("cty_st_numeric","years"),
weight = "population",
force = "two-way",
CV = TRUE,
se = TRUE,
EM = TRUE,
r = c(0,10),
inference = "parametric",
nboots = 300,
parallel = TRUE,
cores =20)
MC_list[[j]] <- gsynth(Y = "estab_pop",
D = "Medicaid",
X = c("estab",
"population",
"GDP",
"GDP_pop",
"Uber_active"),
data = using_model_list[[j]],
index = c("cty_st_numeric","years"),
weight = "population",
force = "two-way",
CV = TRUE,
se = TRUE,
estimator = "mc",
nlambda = 10,
inference = "nonparametric",
nboots = 300,
parallel = TRUE,
cores =20)
}
#######################################################
###                   Interactive FX                ###
#######################################################
inter_fe_list[[1]] <- interFE(estab_pop ~  Medicaid + GDP + GDP_pop,
data = using_model_list[[1]], index=c("cty_st_numeric","years"),
force = "two-way", nboots = 100, se = TRUE, r = 2)
inter_fe_list[[2]] <- interFE(estab_pop ~
Medicaid + Uber_active + Medicaid_Uber  + GDP + GDP_pop,
data = using_model_list[[1]], index=c("cty_st_numeric","years"),
force = "two-way", nboots = 100, se = TRUE, r =  2)
#######################################################
###                   Two Way                       ###
#######################################################
lm_list[[1]] <- lm(estab_pop ~ Medicaid + GDP + GDP_pop + as.factor(years) + as.factor(cty_st_numeric), data = using_model_list[[1]])
lm_list[[2]] <- lm(estab_pop ~ Medicaid+ Uber_active + Medicaid_Uber + GDP + GDP_pop + as.factor(years) + as.factor(cty_st_numeric), data = using_model_list[[1]])
#######################################################
###                   Results                       ###
#######################################################
Sample_list <- c("Full Sample")
summary(lm_list[[1]])
summary(lm_list[[2]])
inter_fe_list[[1]]
inter_fe_list[[2]]
impacted_pop <- sum(using_model_list[[1]]$population[using_model_list[[1]]$years==2014 & using_model_list[[1]]$Medicaid==1])
impacted_pop*lm_list[[1]]$coefficients[2]*4
impacted_pop*lm_list[[2]]$coefficients[2]*4
impacted_pop*inter_fe_list[[1]]$beta[1]*4
impacted_pop*inter_fe_list[[2]]$beta[1]*4
impacted_pop*EM_list[[1]]$att.avg*4
impacted_pop*MC_list[[1]]$att.avg*4
# MEdicaid enrollment increased by 14,098,890 people by December 2017 in expansion states  Monthly Medicaid & CHIP Application, Eligibility Determination, and Enrollment Reports & Data Preliminary December 2017 Report
# $22,108 is 138% of FPL in 2016
# $30,510 is the median earnings for the unincorporated sel-employed (Primary job) "Measuring Entrepreneurship in the American Community Survey: A Demographic and Occupational Profile of Self-Employed Workers"
#  In 2014, 87 percent of all filers earned income solely from wages, while 7 percent earned income solely from self-employment and 6 percent earned a mix from both "U.S. Treasury Department Office of Tax Analysis (Working Paper 114)"
# 14098890*.07 # 7% of people are self-employed as the primary source of income
# 14098890*.07 + 14098890*.06 # 7% of people are self-employed as primary and supplemental
# estimated effect from 2014-2017
# impacted_pop*lm_list[[1]]$coefficients[2]*4/(14098890*.07 + 14098890*.06) # two-way fixed effect estimate reduction in nonemployers as share of full and partial self-employed
# impacted_pop*inter_fe_list[[1]]$beta[1]*4/(14098890*.07 + 14098890*.06)  # interacted fixed effect estimate reduction in nonemployers as share of full and partial self-employed
(impacted_pop*EM_list[[1]]$att[17])/(14098890*.07 + 14098890*.06)  # EM synthetic effect estimate reduction in nonemployers as share of full and partial self-employed
(impacted_pop*MC_list[[1]]$att[17])/(14098890*.07 + 14098890*.06) # Matrix completion effect estimate reduction in nonemployers as share of full and partial self-employed
#######################################
###         Create Plots           ####
#######################################
# gsynth_results <- list()
EM_results <- list()
MC_results <- list()
# gsynth_results[[1]] <- as.data.frame(gsynth_list[[1]]$est.att)
# gsynth_results[[1]]$Period <- seq.int(nrow(gsynth_results[[1]])) - 13
EM_results[[1]] <- as.data.frame(EM_list[[1]]$est.att)
# EM_results[[2]] <- as.data.frame(EM_list[[2]]$est.att)
EM_results[[1]]$Period <- seq.int(nrow(EM_results[[1]])) - 13
# EM_results[[2]]$Period <- seq.int(nrow(EM_results[[2]])) - 13
MC_results[[1]] <- as.data.frame(MC_list[[1]]$est.att)
# MC_results[[2]] <- as.data.frame(MC_list[[2]]$est.att)
MC_results[[1]]$Period <- seq.int(nrow(MC_results[[1]])) - 13
# MC_results[[2]]$Period <- seq.int(nrow(MC_results[[2]])) - 13
# gsynth_results[[1]]$Method <- "Gsynth"
EM_results[[1]]$Method <- "EM Algorithm"
MC_results[[1]]$Method <- "Matrix Completion"
pdf(paste0("Synth_EM_v_MC_",industry_list[i],".pdf"), width = 8, height = 6)
ggplot(data = EM_results[[1]], aes(x = Period, y = ATT, color = Method, linetype = Method, shape = Method)) +
geom_point(size = 3) +
geom_line(size = 1) +
geom_ribbon(aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
geom_point(data = MC_results[[1]], size = 3) +
geom_line(data = MC_results[[1]], size = 1) +
geom_ribbon(data = MC_results[[1]], aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
# geom_point(data = gsynth_results[[1]], size = 3) +
# geom_line(data = gsynth_results[[1]], size = 1) +
# geom_ribbon(data = gsynth_results[[1]], aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
geom_hline(yintercept = 0, color ="black") +
geom_vline(xintercept = 0.5, color = "black", linetype = "longdash") +
# ylim(-0.0035, 0.001) +
ggtitle("Gsynth vs EM Method vs MC Method") +
theme(plot.title = element_blank(),
axis.text.x = element_text(size = 25, angle = 0),
axis.text.y = element_text(size = 25),
axis.title.y = element_text(size = 25),
axis.title.x = element_text(size = 25),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.background = element_rect(fill=NA),
legend.text = element_text(size = 20),
legend.key = element_rect(fill="white"),
legend.title = element_blank())
# +  guides(col = guide_legend("Lines",nrow=2,override.aes = list(size=2), order = 1),
# shape = guide_legend(nrow=2,order = 2))
dev.off()
for(i in seq_along(using_model_list)){
plot(EM_list[[i]],
type = "gap",
xlab = "Period",
main = paste0("ATE, EM ",Sample_list[i]),
theme.bw = TRUE)
plot(MC_list[[i]],
type = "gap",
xlab = "Period",
main = paste0("ATE, MC ",Sample_list[i]),
theme.bw = TRUE)
plot(EM_list[[i]],
type = "counterfactual",
xlab = "Period",
main = paste0("ATE, EM ",Sample_list[i]),
theme.bw = TRUE)
plot(MC_list[[i]],
type = "counterfactual",
xlab = "Period",
main = paste0("ATE, MC ",Sample_list[i]),
theme.bw = TRUE)
}
#####    Effect Estimates     ######
effect_estimates_EM <-as.data.frame(EM_list[[1]]$eff)
effect_estimates_MC <-as.data.frame(MC_list[[1]]$eff)
effect_estimates_EM_long <- gather(effect_estimates_EM,cty_st_numeric, effect_estimate_EM, "68":"3141", factor_key=TRUE)
effect_estimates_EM_long$years <- rep(seq(2001,2017,1), times = 1457)
effect_estimates_MC_long <- gather(effect_estimates_MC,cty_st_numeric, effect_estimate_MC, "68":"3141", factor_key=TRUE)
effect_estimates_MC_long$years <- rep(seq(2001,2017,1), times = 1457)
effect_estimates <- merge(effect_estimates_EM_long, effect_estimates_MC_long)
yearly_pop <- using_model_list[[1]] %>% dplyr::select("population",
"Medicaid",
"Uber_active",
"cty_st_numeric",
"years",
"id")
effect_estimates <- merge(effect_estimates, yearly_pop)
effect_estimates$change_EM <- effect_estimates$effect_estimate_EM*effect_estimates$population
effect_estimates$change_MC <- effect_estimates$effect_estimate_MC*effect_estimates$population
aggregate(x = effect_estimates$change_EM, by = list(effect_estimates$years), FUN = "sum")
aggregate(x = effect_estimates$change_MC, by = list(effect_estimates$years), FUN = "sum")
ggplot(effect_estimates, aes(x = years,
y = effect_estimate_EM,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
ggplot(effect_estimates, aes(x = years,
y = effect_estimate_MC,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
for(i in seq_along(using_model_list)){
plot(EM_list[[i]],
type = "gap",
xlab = "Period",
main = paste0("ATE, EM ",Sample_list[i]),
theme.bw = TRUE)
plot(MC_list[[i]],
type = "gap",
xlab = "Period",
main = paste0("ATE, MC ",Sample_list[i]),
theme.bw = TRUE)
plot(EM_list[[i]],
type = "counterfactual",
xlab = "Period",
main = paste0("ATE, EM ",Sample_list[i]),
theme.bw = TRUE)
plot(MC_list[[i]],
type = "counterfactual",
xlab = "Period",
main = paste0("ATE, MC ",Sample_list[i]),
theme.bw = TRUE)
}
# gsynth_results <- list()
EM_results <- list()
MC_results <- list()
EM_results[[1]] <- as.data.frame(EM_list[[1]]$est.att)
EM_results[[1]]$Period <- seq.int(nrow(EM_results[[1]])) - 13
MC_results[[1]] <- as.data.frame(MC_list[[1]]$est.att)
MC_results[[1]]$Period <- seq.int(nrow(MC_results[[1]])) - 13
# gsynth_results[[1]]$Method <- "Gsynth"
EM_results[[1]]$Method <- "EM Algorithm"
MC_results[[1]]$Method <- "Matrix Completion"
ggplot(data = EM_results[[1]], aes(x = Period, y = ATT, color = Method, linetype = Method, shape = Method)) +
geom_point(size = 3) +
geom_line(size = 1) +
geom_ribbon(aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
geom_point(data = MC_results[[1]], size = 3) +
geom_line(data = MC_results[[1]], size = 1) +
geom_ribbon(data = MC_results[[1]], aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
# geom_point(data = gsynth_results[[1]], size = 3) +
# geom_line(data = gsynth_results[[1]], size = 1) +
# geom_ribbon(data = gsynth_results[[1]], aes(ymin=CI.lower, ymax=CI.upper), alpha=0.2) +
geom_hline(yintercept = 0, color ="black") +
geom_vline(xintercept = 0.5, color = "black", linetype = "longdash") +
# ylim(-0.0035, 0.001) +
ggtitle("Gsynth vs EM Method vs MC Method") +
theme(plot.title = element_blank(),
axis.text.x = element_text(size = 25, angle = 0),
axis.text.y = element_text(size = 25),
axis.title.y = element_text(size = 25),
axis.title.x = element_text(size = 25),
panel.background = element_rect(fill = "white"),
panel.grid = element_line(colour = "grey"),
axis.line = element_line(colour = "black"),
legend.position = "bottom",
legend.background = element_rect(fill=NA),
legend.text = element_text(size = 20),
legend.key = element_rect(fill="white"),
legend.title = element_blank())
effect_estimates_EM <-as.data.frame(EM_list[[1]]$eff)
effect_estimates_MC <-as.data.frame(MC_list[[1]]$eff)
effect_estimates_EM_long <- gather(effect_estimates_EM,cty_st_numeric, effect_estimate_EM, "68":"3141", factor_key=TRUE)
View(effect_estimates_EM)
effect_estimates_EM <-as.data.frame(EM_list[[1]]$eff)
effect_estimates_MC <-as.data.frame(MC_list[[1]]$eff)
effect_estimates_EM_long <- gather(effect_estimates_EM,cty_st_numeric, effect_estimate_EM, "68":"3141", factor_key=TRUE)
effect_estimates_EM_long$years <- rep(seq(2001,2017,1), times = 1480)
effect_estimates_MC_long <- gather(effect_estimates_MC,cty_st_numeric, effect_estimate_MC, "68":"3141", factor_key=TRUE)
effect_estimates_MC_long$years <- rep(seq(2001,2017,1), times = 1480)
effect_estimates <- merge(effect_estimates_EM_long, effect_estimates_MC_long)
yearly_pop <- using_model_list[[1]] %>% dplyr::select("population",
"Medicaid",
"Uber_active",
"cty_st_numeric",
"years",
"id")
effect_estimates <- merge(effect_estimates, yearly_pop)
effect_estimates$change_EM <- effect_estimates$effect_estimate_EM*effect_estimates$population
effect_estimates$change_MC <- effect_estimates$effect_estimate_MC*effect_estimates$population
View(effect_estimates)
aggregate(x = effect_estimates$change_EM, by = list(effect_estimates$years), FUN = "sum")
aggregate(x = effect_estimates$change_MC, by = list(effect_estimates$years), FUN = "sum")
ggplot(effect_estimates, aes(x = years,
y = effect_estimate_EM,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
ggplot(effect_estimates, aes(x = years,
y = effect_estimate_MC,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
ggplot(effect_estimates, aes(x = years,
y = change_MC,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
ggplot(effect_estimates, aes(x = years,
y = change_EM,
weight = population,
color = as.factor(Medicaid),
shape = as.factor(Uber_active),
size = population)) +
geom_jitter(position=position_jitter(0.2)) +
theme_bw()
plot(MC_list[1], type = "counterfactual")
plot(MC_list[[1]], type = "counterfactual")
